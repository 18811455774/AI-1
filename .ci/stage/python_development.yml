parameters:
  Agent: Hosted Ubuntu 1604

stages:
- stage: ${{parameters.stageName}}
  dependsOn: []    
  jobs:
  - job: Development
    displayName: ${{parameters.jobDisplayName}}

    pool:
      name: ${{parameters.Agent}}
      demands: ${{parameters.Demands}}
 
    timeoutInMinutes: ${{parameters.jobTimeoutInMinutes}}
 
    workspace:
      clean: all
  
    variables:
    - pypi_pythonDownloadServiceConnections: ${{parameters.pypi_pythonDownloadServiceConnections}}
  
    steps:
    - task: UsePythonVersion@0
      displayName: 'Use Python 3.7'
      inputs:
        versionSpec: 3.7
    - task: PipAuthenticate@1
      inputs:
        artifactFeeds: $(pypi_artifactFeeds)
        pythonDownloadServiceConnections: ${{parameters.pypi_pythonDownloadServiceConnections}}
        onlyAddExtraIndex: true
    - script: |
        pip install --upgrade pip
      displayName: 'Update Pip'
    - script: |
        pip install tox
      displayName: 'Install Tox'
    - script: |
        tox -e py
      displayName: "Run Tox"
      env:
        VERSION: $(Build.BuildNumber)
    - script: |
        pip install pylint junit-xml pylint-junit
        pylint ./cdm2ai
        pylint --output-format=junit ./cdm2ai >> test-pylint-results.xml
      displayName: PyLint
      continueOnError: true
    - task: PublishTestResults@2
      condition: succeededOrFailed()
      inputs:
        testResultsFiles: '**/test-*.xml'
        testRunTitle: 'Publish test results for Python 3.7'
    - task: PublishCodeCoverageResults@1
      inputs:
        codeCoverageTool: Cobertura
        summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
