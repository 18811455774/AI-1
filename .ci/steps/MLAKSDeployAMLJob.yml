

parameters:
  azureSubscription: 'AICAT-VB-E2E (989b90f7-da4f-41f9-84c9-44848802052d)'
  azure_subscription: 989b90f7-da4f-41f9-84c9-44848802052d
  azureresourcegroup: dciborowhp
  workspacename: dciborowhpws
  azureregion: westus2
  aksimagename: dciborowhpaks
  aks_name: dciborowhpaks
  aks_service_name: dciborowhpaksapi
  location: DeployMLModelKubernetes/{{cookiecutter.project_name}}
  conda: MLAKSDeployAML

steps:
- task: AzureCLI@1
  displayName: 'Add Conda to Path'
  inputs:
    azureSubscription: ${{parameters.azureSubscription}}
    scriptLocation: inlineScript
    inlineScript: 'echo "##vso[task.prependpath]$CONDA/bin"'

- task: AzureCLI@1
  displayName: 'Setup Conda'
  inputs:
    azureSubscription: ${{parameters.azureSubscription}}
    scriptLocation: inlineScript
    inlineScript: |
      conda env create -f ${{location}}/environment.yml
      source activate ${{conda}}

- task: AzureCLI@1
  displayName: '00_AMLConfiguration.ipynb'
  inputs:
    azureSubscription: ${{parameters.azureSubscription}}
    scriptLocation: 'inlineScript'
    inlineScript: |
      source activate ${{conda}}
      cd ${{location}}
      echo Execute 00_AMLConfiguration.ipynb
      papermill 00_AMLConfiguration.ipynb 00_AMLConfiguration_Output.ipynb \
        --log-output \
        --no-progress-bar \
        -k python3 \
        -p subscription_id ${{parameters.azure_subscription}} \
        -p resource_group ${{parameters.azureresourcegroup}} \
        -p workspace_name ${{parameters.workspacename}} \
        -p workspace_region ${{parameters.azureregion}} \
        -p image_name ${{parameters.aksimagename}}

- template: azpapermill.yml
  parameters:
    notebook: 01_DataPrep.ipynb
    location: ${{location}}
    azureSubscription: ${{parameters.azureSubscription}}

- bash: |
    mkdir -p ${{location}}/iotedge/data_folder
    mkdir -p ${{location}}/aks/data_folder
    cd ${{location}}
    cp data_folder/*.tsv iotedge/data_folder
    cp data_folder/*.tsv aks/data_folder
  displayName: 'Copying data'

- template: azpapermill.yml
  parameters:
    notebook: 02_TrainOnLocal.ipynb
    location: ${{location}}
    azureSubscription: ${{parameters.azureSubscription}}
    conda: ${{conda}}

- template: azpapermill.yml
  parameters:
    notebook: 03_DevelopScoringScript.ipynb
    location: ${{location}}
    azureSubscription: ${{parameters.azureSubscription}}
    conda: ${{conda}}

- template: azpapermill.yml
  parameters:
    notebook: 04_CreateImage.ipynb
    location: ${{location}}
    azureSubscription: ${{parameters.azureSubscription}}
    conda: ${{conda}}

- task: AzureCLI@1
  displayName: '05_DeployOnAKS.ipynb'
  inputs:
    azureSubscription: ${{parameters.azureSubscription}}
    scriptLocation: inlineScript
    inlineScript: |
      source activate ${{conda}}
      export PYTHONPATH=$(pwd)/${{location}}:${PYTHONPATH}
      cd ${{location}}/aks
      echo Execute 05_DeployOnAKS.ipynb
      papermill 05_DeployOnAKS.ipynb test.ipynb \
        --log-output \
        --no-progress-bar \
        -k python3 \
        -p aks_name ${{parameters.aks_name}} \
        -p aks_location ${{parameters.azureregion}} \
        -p aks_service_name ${{parameters.aks_service_name}}
